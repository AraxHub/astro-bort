# –ü–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

## üìã –°—É–º–º–∞—Ä–∏–∑ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π (—Å–µ—Å—Å–∏—è)

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

1. **–£–±—Ä–∞–ª–∏ botID –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**
   - –ü–µ—Ä–µ–¥–∞—ë–º `botID` —è–≤–Ω–æ —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–µ—Ç–æ–¥–æ–≤
   - –£–¥–∞–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ `WithBotID` –∏ `getBotIDFromContext`
   - –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
     - `IBotService`: –¥–æ–±–∞–≤–ª–µ–Ω `botID` –≤ –º–µ—Ç–æ–¥—ã
     - `ITelegramService`: –¥–æ–±–∞–≤–ª–µ–Ω `botID` –≤ –º–µ—Ç–æ–¥—ã
     - –í—Å–µ UseCase –º–µ—Ç–æ–¥—ã –ø—Ä–∏–Ω–∏–º–∞—é—Ç `botID` —è–≤–Ω–æ

2. **–î–æ–±–∞–≤–∏–ª–∏ –¥–æ–º–µ–Ω–Ω—ã–π —Ç–∏–ø `BotId`**
   - –°–æ–∑–¥–∞–Ω `domain.BotId` –≤–º–µ—Å—Ç–æ `string`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ–∑–¥–µ –¥–ª—è —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
   - –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –º–∞–ø–ø–∏–Ω–≥–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

3. **–í—ã–Ω–µ—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–æ—Ç–æ–≤ –≤ env**
   - –ü—Ä–µ—Ñ–∏–∫—Å–Ω–∞—è –Ω–æ—Ç–∞—Ü–∏—è: `ASTRO_BOT_BOT_0_ID`, `ASTRO_BOT_BOT_0_TYPE`, `ASTRO_BOT_BOT_0_TOKEN`
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ `BotConfig` —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
   - –ú–µ—Ç–æ–¥ `ToDomain()` –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ –¥–æ–º–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã
   - –£–±—Ä–∞–Ω —Ö–∞—Ä–¥–∫–æ–¥ –∏–∑ `app.go`

4. **–£–ø—Ä–æ—Å—Ç–∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É app.go**
   - –†–∞–∑–¥–µ–ª–∏–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é webhook –∏ polling
   - –ú–µ—Ç–æ–¥ `initPolling()` –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
   - –ú–µ—Ç–æ–¥ `runPolling()` –¥–ª—è –∑–∞–ø—É—Å–∫–∞ polling
   - –Ø–≤–Ω—ã–π –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –≤ `runServices()`

5. **–ù–∞—á–∞–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Secret Token –¥–ª—è webhook**
   - –ò–∑–º–µ–Ω—ë–Ω endpoint: `/webhook/:bot_id` ‚Üí `/webhook/`
   - `botID` —Ç–µ–ø–µ—Ä—å –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `X-Telegram-Bot-Api-Secret-Token`
   - TODO: —Å–¥–µ–ª–∞—Ç—å —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π botID –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ

### üìù –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `internal/ports/service/bot_service.go` - –¥–æ–±–∞–≤–ª–µ–Ω botID –≤ –º–µ—Ç–æ–¥—ã
- `internal/ports/service/telegram.go` - –¥–æ–±–∞–≤–ª–µ–Ω botID –≤ –º–µ—Ç–æ–¥—ã
- `internal/services/telegram/module.go` - —É–±—Ä–∞–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- `internal/services/telegram/handler.go` - –ø–µ—Ä–µ–¥–∞—á–∞ botID —è–≤–Ω–æ
- `internal/services/telegram/sender.go` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ botID –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- `internal/usecases/astro/*` - –≤—Å–µ –º–µ—Ç–æ–¥—ã –ø—Ä–∏–Ω–∏–º–∞—é—Ç botID —è–≤–Ω–æ
- `internal/domain/telegram.go` - –¥–æ–±–∞–≤–ª–µ–Ω —Ç–∏–ø `BotId`
- `internal/domain/request.go` - `BotID` —Ç–µ–ø–µ—Ä—å `domain.BotId`
- `internal/app/config.go` - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `BotConfig` –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ env
- `internal/app/app.go` - —É–±—Ä–∞–Ω —Ö–∞—Ä–¥–∫–æ–¥, —É–ø—Ä–æ—â–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- `internal/adapters/primary/http/controllers/telegram/controllerWebhook.go` - –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ secret_token

---

## üéØ –ü–ª–∞–Ω –Ω–∞ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è

- [ ]  –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–¢–¨ –ö–û–ú–ê–ù–î–´ –ò –ë–ò–ó–ù–ï–° –õ–û–ì–ò–ö–£ –õ–û–ö–ê–õ–¨–ù–û –° –ü–û–ú–û–©–¨–Æ –ü–û–õ–ò–ù–ì–ê


### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ Secret Token

- [ ] **–ò—Å–ø—Ä–∞–≤–∏—Ç—å TODO –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ**
  - –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `botID` –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≤ `domain.BotId` —Å—Ä–∞–∑—É
  - –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è bot_id –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  
- [ ] **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥ `SetWebhook` –≤ Telegram Client**
  - `internal/adapters/secondary/telegram/client.go`
  - –ú–µ—Ç–æ–¥ –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–Ω–∏–º–∞—Ç—å `url` –∏ `secretToken`
  - API: `POST /setWebhook?url=...&secret_token=...`

- [ ] **–î–æ–±–∞–≤–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É webhook –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**
  - –í `app.go` –ø—Ä–∏ `UseWebhook=true`
  - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–æ—Ç–∞ –≤—ã–∑—ã–≤–∞—Ç—å `SetWebhook` —Å URL –∏ `secret_token=bot_id`
  - URL: `{WebhookURL}/webhook`

- [ ] **–û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é**
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å `docs/webhook-architecture.md`
  - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –£–ª—É—á—à–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

- [ ] **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –±–æ—Ç–æ–≤ –≤ polling** - –ù–ï –ù–ê–î–û
  - –°–µ–π—á–∞—Å polling —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –±–æ—Ç–∞
  - TODO –≤ `initPolling()`: –∑–∞–ø—É—Å–∫–∞—Ç—å polling –¥–ª—è –≤—Å–µ—Ö –±–æ—Ç–æ–≤ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞

- [ ] **–í–∞–ª–∏–¥–∞—Ü–∏—è bot_id –≤ webhook –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ**
  - –ü—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ bot_id –∏–∑ secret_token —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  - –í–æ–∑–≤—Ä–∞—â–∞—Ç—å 400 Bad Request –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö bot_id

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞

- [ ] **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å webhook —Å secret_token**
  - –õ–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ ngrok –∏–ª–∏ –ø–æ–¥–æ–±–Ω–æ–µ
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É webhook –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–æ—Ç–∞
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

- [ ] **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–æ—Ç–æ–≤ –∏–∑ env**
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –±–æ—Ç–æ–≤
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4: –ë—É–¥—É—â–∏–µ –∑–∞–¥–∞—á–∏

- [ ] **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è Kafka producer/consumer –¥–ª—è RAG**
  - Producer –≤ UseCase –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
  - Consumer –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤
  - –ö–æ–Ω—Ç—Ä–∞–∫—Ç: `request_id`, `request_text`, `natal_chart` ‚Üí `request_id`, `response_text`

- [ ] **–í—ã–Ω–µ—Å—Ç–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–æ—Ç–æ–≤ –∏–∑ env –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª**
  - –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å YAML/JSON –∫–æ–Ω—Ñ–∏–≥ (–µ—Å–ª–∏ –±–æ—Ç–æ–≤ —Å—Ç–∞–Ω–µ—Ç –º–Ω–æ–≥–æ)
  - –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `docs/webhook-architecture.md` - –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ webhook —Å Secret Token
- `docs/ux-flow.md` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–ª–æ—É –±–æ—Ç–∞

---

## üîç –¢–µ–∫—É—â–∏–µ TODO –≤ –∫–æ–¥–µ

1. `internal/adapters/primary/http/controllers/telegram/controllerWebhook.go:29` - —Å–¥–µ–ª–∞—Ç—å —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π botID
2. `internal/app/app.go:191` - –∑–∞–ø—É—Å–∫–∞—Ç—å polling –¥–ª—è –≤—Å–µ—Ö –±–æ—Ç–æ–≤ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
3. `internal/usecases/astro/text_handler.go:140` - —Ä–µ—Ñ–∞–∫—Ç–æ—Ä –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ RAG
