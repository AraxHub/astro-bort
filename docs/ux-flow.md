# UX Flow - –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –±–æ—Ç

## –û–±–∑–æ—Ä

–î–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º –±–æ—Ç–æ–º, –≤–∫–ª—é—á–∞—è –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, –∫–æ–º–∞–Ω–¥—ã –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.

## –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### 1. –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

```mermaid
flowchart TD
    Start([–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç /start]) --> CheckBirthDate{–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è<br/>—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞?}
    
    CheckBirthDate -->|–ù–µ—Ç| ShowBirthWarning[–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ:<br/>üê± –ü—Ä–∏–≤–µ—Ç! –Ø –ö–∏—Ç–∞<br/>‚ö†Ô∏è –î–∞—Ç–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –û–î–ò–ù –†–ê–ó<br/>–ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã —Ç–æ–ª—å–∫–æ –æ—Ç —Å–≤–æ–µ–≥–æ –ª–∏—Ü–∞]
    ShowBirthWarning --> WaitBirthInput[–û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞ –¥–∞—Ç—ã:<br/>–î–î.–ú–ú.–ì–ì–ì–ì —á—á:–º–º –ì–æ—Ä–æ–¥<br/>–∏–ª–∏<br/>–î–î.–ú–ú.–ì–ì–ì–ì —á—á:–º–º –ì–æ—Ä–æ–¥, –ö–æ–¥–°—Ç—Ä–∞–Ω—ã]
    WaitBirthInput --> ValidateBirthDate{–í–∞–ª–∏–¥–∞—Ü–∏—è<br/>–¥–∞—Ç—ã, –≤—Ä–µ–º–µ–Ω–∏<br/>–∏ –º–µ—Å—Ç–∞}
    
    ValidateBirthDate -->|–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç| ShowError[–ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É:<br/>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç<br/>–ò—Å–ø–æ–ª—å–∑—É–π: –î–î.–ú–ú.–ì–ì–ì–ì —á—á:–º–º –ì–æ—Ä–æ–¥]
    ShowError --> WaitBirthInput
    
    ValidateBirthDate -->|–í–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç| SaveBirthDate[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è:<br/>birth_datetime = –¥–∞—Ç–∞+–≤—Ä–µ–º—è<br/>birth_place = –º–µ—Å—Ç–æ<br/>birth_data_set_at = NOW<br/>birth_data_can_change_until = NOW + 24h]
    SaveBirthDate --> RequestNatalChart[–ó–∞–ø—Ä–æ—Å –≤ –∞—Å—Ç—Ä–æ-API<br/>–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã]
    RequestNatalChart --> SaveNatalChart{–£—Å–ø–µ—à–Ω–æ?}
    
    SaveNatalChart -->|–û—à–∏–±–∫–∞| ShowNatalErrorAfterSave[–ü–æ–∫–∞–∑–∞—Ç—å:<br/>‚úÖ –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–Ω—è—Ç—ã<br/>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–∞—Ä—Ç—É]
    ShowNatalErrorAfterSave --> WaitUserQuestion
    
    SaveNatalChart -->|–£—Å–ø–µ—à–Ω–æ| SaveNatalChartDB[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É:<br/>natal_chart = –¥–∞–Ω–Ω—ã–µ<br/>natal_chart_fetched_at = NOW<br/>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Kafka –¥–ª—è rerank-natal]
    SaveNatalChartDB --> ShowBirthSuccess[–ü–æ–∫–∞–∑–∞—Ç—å:<br/>üéâ –ì–æ—Ç–æ–≤–æ! –ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞!<br/>‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã<br/>‚ö†Ô∏è –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ 24—á]
    ShowBirthSuccess --> WaitUserQuestion
    
    CheckBirthDate -->|–î–∞| CheckNatalChart{–ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞<br/>–µ—Å—Ç—å?<br/>NatalChartFetchedAt != nil}
    
    CheckNatalChart -->|–ù–µ—Ç| RequestNatalChartStart[–ó–∞–ø—Ä–æ—Å –≤ –∞—Å—Ç—Ä–æ-API<br/>–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã]
    RequestNatalChartStart --> SaveNatalChartStart{–£—Å–ø–µ—à–Ω–æ?}
    
    SaveNatalChartStart -->|–û—à–∏–±–∫–∞| ShowNatalError[–ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É:<br/>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å<br/>–Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É]
    ShowNatalError --> WaitUserQuestion
    
    SaveNatalChartStart -->|–£—Å–ø–µ—à–Ω–æ| ShowReady[–ü–æ–∫–∞–∑–∞—Ç—å:<br/>üê± –ü—Ä–∏–≤–µ—Ç —Å–Ω–æ–≤–∞!<br/>–ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞,<br/>–≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ]
    
    CheckNatalChart -->|–î–∞| ShowReady
    
    ShowReady --> WaitUserQuestion[–û–∂–∏–¥–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞<br/>–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]
    
    style Start fill:#90EE90
    style ShowReady fill:#87CEEB
    style SaveBirthDate fill:#FFD700
    style SaveNatalChartDB fill:#FFD700
```

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

```mermaid
flowchart TD
    WaitUserQuestion[–û–∂–∏–¥–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞<br/>–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è] --> CreateRequest[–°–æ–∑–¥–∞—Ç—å –∑–∞–ø—Ä–æ—Å:<br/>requests: user_id, request_text, tg_update_id<br/>request_type = 'user'<br/>status: —Å–æ–∑–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ defer]
    
    CreateRequest --> CheckNatalChartAgain{–ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞<br/>–µ—Å—Ç—å?<br/>NatalChartFetchedAt != nil}
    
    CheckNatalChartAgain -->|–ù–µ—Ç| RequestNatalChartOnQuestion[–ó–∞–ø—Ä–æ—Å –≤ –∞—Å—Ç—Ä–æ-API<br/>–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã]
    RequestNatalChartOnQuestion --> SaveNatalChartOnQuestion{–£—Å–ø–µ—à–Ω–æ?}
    
    SaveNatalChartOnQuestion -->|–û—à–∏–±–∫–∞| ShowNatalErrorOnQuestion[–ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É:<br/>‚ùå –ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞<br/>–ò—Å–ø–æ–ª—å–∑—É–π /start]
    ShowNatalErrorOnQuestion --> WaitUserQuestion
    
    SaveNatalChartOnQuestion -->|–£—Å–ø–µ—à–Ω–æ| GetNatalChart[–ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É<br/>–∏–∑ –ë–î: GetNatalChart]
    
    CheckNatalChartAgain -->|–î–∞| GetNatalChart
    
    GetNatalChart --> CheckChartNotEmpty{–ö–∞—Ä—Ç–∞<br/>–Ω–µ –ø—É—Å—Ç–∞—è?}
    
    CheckChartNotEmpty -->|–ü—É—Å—Ç–∞—è| RequestNatalChartOnQuestion
    
    CheckChartNotEmpty -->|–ï—Å—Ç—å| SendToKafka[–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Kafka:<br/>topic: requests<br/>value: request_text, natal_chart<br/>headers: request_id, bot_id, chat_id, action='chat'<br/>status: 'sent_to_rag']
    
    SendToKafka --> SendConfirmation[–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:<br/>‚úÖ –ó–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω<br/>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...<br/>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å tech_msg_id –≤ –∫—ç—à]
    
    SendConfirmation --> WaitRAGResponse[–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞<br/>–∏–∑ Kafka —Ç–æ–ø–∏–∫–∞ responses]
    
    WaitRAGResponse --> ReceiveRAGResponse[–ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –∏–∑ Kafka:<br/>—Ç–æ–ø–∏–∫: responses<br/>–¥–∞–Ω–Ω—ã–µ: request_id, bot_id, chat_id, response_text<br/>action: 'chat' –∏–ª–∏ 'image_type']
    
    ReceiveRAGResponse --> CheckAction{action?}
    
    CheckAction -->|'chat'| UpdateRequest[–û–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –≤ –ë–î:<br/>requests.response = response_text]
    UpdateRequest --> DeleteTechMessage[–£–¥–∞–ª–∏—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ<br/>'‚úÖ –ó–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω...']
    DeleteTechMessage --> SendTextResponse[–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç:<br/>parse_mode: MarkdownV2<br/>–†–∞–∑–±–∏—Ç—å –Ω–∞ —á–∞—Å—Ç–∏ –µ—Å–ª–∏ > 4000 —Å–∏–º–≤–æ–ª–æ–≤]
    SendTextResponse --> CreateStatusSuccess[–°–æ–∑–¥–∞—Ç—å —Å—Ç–∞—Ç—É—Å:<br/>status = 'completed'<br/>metadata = telegram metadata]
    CreateStatusSuccess --> WaitUserQuestion
    
    CheckAction -->|'image_type'| SendImage[–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –ø–æ —Ç–µ–º–µ<br/>–ù–µ —É–¥–∞–ª—è—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]
    SendImage --> WaitUserQuestion
    
    style SendToKafka fill:#DDA0DD
    style ReceiveRAGResponse fill:#98FB98
    style DeleteTechMessage fill:#FFB6C1
```

### 3. –ö–æ–º–∞–Ω–¥—ã

```mermaid
flowchart TD
    WaitUserQuestion[–û–∂–∏–¥–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞<br/>–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è] -->|–ö–æ–º–∞–Ω–¥–∞ /reset_birth_data| CheckResetTime{–ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å?<br/>birth_data_can_change_until > NOW?}
    
    CheckResetTime -->|–ù–µ—Ç| ShowResetError[–ü–æ–∫–∞–∑–∞—Ç—å:<br/>‚ùå –î–∞—Ç–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞<br/>–û–±—Ä–∞—Ç–∏—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É]
    ShowResetError --> WaitUserQuestion
    
    CheckResetTime -->|–î–∞| ShowResetWarning[–ü–æ–∫–∞–∑–∞—Ç—å:<br/>‚ö†Ô∏è –¢—ã —É–≤–µ—Ä–µ–Ω?<br/>–≠—Ç–æ —É–¥–∞–ª–∏—Ç –¥–∞—Ç—É –∏ –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É<br/>–í–≤–µ–¥–∏ '–ü–û–î–¢–í–ï–†–î–ò–¢–¨']
    ShowResetWarning --> WaitConfirm[–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è]
    
    WaitConfirm -->|'–ü–û–î–¢–í–ï–†–î–ò–¢–¨'| ResetBirthData[–°–±—Ä–æ—Å–∏—Ç—å:<br/>birth_datetime = NULL<br/>birth_place = NULL<br/>birth_data_set_at = NULL<br/>birth_data_can_change_until = NULL<br/>natal_chart_fetched_at = NULL<br/>natal_chart –æ—Å—Ç–∞—ë—Ç—Å—è –≤ –ë–î<br/>–Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è]
    ResetBirthData --> ShowResetSuccess[–ü–æ–∫–∞–∑–∞—Ç—å:<br/>‚úÖ –î–∞—Ç–∞ –∏ –∫–∞—Ä—Ç–∞ —Å–±—Ä–æ—à–µ–Ω—ã<br/>–í–≤–µ–¥–∏ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ]
    ShowResetSuccess --> WaitBirthInput
    
    WaitConfirm -->|–î—Ä—É–≥–æ–µ| WaitUserQuestion
    
    WaitUserQuestion -->|–ö–æ–º–∞–Ω–¥–∞ /help| ShowHelp[–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É:<br/>/start - –ù–∞—á–∞—Ç—å<br/>/reset_birth_data - –°–±—Ä–æ—Å–∏—Ç—å –¥–∞—Ç—É<br/>/my_info - –ú–æ—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è]
    ShowHelp --> WaitUserQuestion
    
    WaitUserQuestion -->|–ö–æ–º–∞–Ω–¥–∞ /my_info| ShowUserInfo[–ü–æ–∫–∞–∑–∞—Ç—å:<br/>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: birth_datetime<br/>–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è: birth_place<br/>–ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞: ‚úÖ/‚ùå<br/>–¢–∞—Ä–∏—Ñ: –∫—É–ø–ª–µ–Ω/–Ω–µ –∫—É–ø–ª–µ–Ω<br/>–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ä–µ–∞–ª—å–Ω–æ–µ –Ω–∞–ª–∏—á–∏–µ<br/>–≤ –ë–î —á–µ—Ä–µ–∑ GetNatalChart]
    ShowUserInfo --> WaitUserQuestion
```

## –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —ç—Ç–∞–ø–æ–≤

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–¢—Ä–∏–≥–≥–µ—Ä:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `/start`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è –≤ –ë–î
2. –ï—Å–ª–∏ –¥–∞—Ç—ã –Ω–µ—Ç ‚Üí –ø–æ–∫–∞–∑ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –ø–æ –≤–≤–æ–¥—É
3. –ï—Å–ª–∏ –¥–∞—Ç–∞ –µ—Å—Ç—å, –Ω–æ –∫–∞—Ä—Ç—ã –Ω–µ—Ç ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã
4. –ï—Å–ª–∏ –≤—Å—ë –µ—Å—Ç—å ‚Üí –ø–æ–∫–∞–∑ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—â–∞—é—â–µ–≥–æ—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è

**–§–æ—Ä–º–∞—Ç –≤–≤–æ–¥–∞:**
- `–î–î.–ú–ú.–ì–ì–ì–ì —á—á:–º–º –ì–æ—Ä–æ–¥, –ö–æ–¥–°—Ç—Ä–∞–Ω—ã` (–Ω–∞–ø—Ä–∏–º–µ—Ä: `15.03.1990 14:30 –ú–æ—Å–∫–≤–∞, RU`)
- `–î–î.–ú–ú.–ì–ì–ì–ì —á—á:–º–º –ì–æ—Ä–æ–¥` (–Ω–∞–ø—Ä–∏–º–µ—Ä: `15.03.1990 14:30 –ú–æ—Å–∫–≤–∞`)

**–í–∞–ª–∏–¥–∞—Ü–∏—è:**
- –§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
- –î–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –±—É–¥—É—â–µ–º
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑–∞–Ω–∏–µ –º–µ—Å—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è

**–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:**
- `birth_datetime` - –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è
- `birth_place` - –º–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è
- `birth_data_set_at` - –≤—Ä–µ–º—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
- `birth_data_can_change_until` - –≤—Ä–µ–º—è –¥–æ –∫–æ—Ç–æ—Ä–æ–≥–æ –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å (NOW + 24 —á–∞—Å–∞)

**–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã –∏–∑ –∞—Å—Ç—Ä–æ-API
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis (–±–µ–∑ TTL)
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
- **–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Kafka –¥–ª—è rerank-natal** (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞—á–∞–ª—å–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏):
  - topic: requests
  - headers: `action=rerank_natal`, `bot_id`, `chat_id`
  - value: `{"request_text": "", "natal_chart": <natal_report>}`

### –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏:**
1. Redis (–∫—ç—à, –±–µ–∑ TTL) - –∫–ª—é—á: `astro:natal:{chat_id}`
2. –ë–î (lazy loading) - –ø–æ–ª–µ `natal_chart` (JSONB)

**–õ–æ–≥–∏–∫–∞:**
- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã ‚Üí –∑–∞–ø—Ä–æ—Å –≤ –∞—Å—Ç—Ä–æ-API
- –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–∞—Ä—Ç—ã ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å
- –ü—Ä–∏ –ø—É—Å—Ç–æ–π –∫–∞—Ä—Ç–µ –≤ –ë–î ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å

**–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:**
- Redis: —Å—Ç—Ä–æ–∫–∞ (JSON)
- –ë–î: JSONB –ø–æ–ª–µ `natal_chart`
- –§–ª–∞–≥ `natal_chart_fetched_at` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–æ–ª—É—á–µ–Ω–∏–∏

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

**–¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞:** `RequestTypeUser`

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞:**
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü—É `requests`
   - `request_type = 'user'`
   - `tg_update_id` - ID –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ Telegram

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã:**
   - –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å
   - –ï—Å–ª–∏ –ø—É—Å—Ç–∞—è ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤ –∞—Å—Ç—Ä–æ-API

3. **–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Kafka:**
   - Topic: `requests`
   - Value: `{"request_text": <—Ç–µ–∫—Å—Ç>, "natal_chart": <JSON>}`
   - Headers:
     - `request_id` - UUID –∑–∞–ø—Ä–æ—Å–∞
     - `bot_id` - ID –±–æ—Ç–∞
     - `chat_id` - ID —á–∞—Ç–∞
     - `action` - —Ç–∏–ø –¥–µ–π—Å—Ç–≤–∏—è (`chat` –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)

4. **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:**
   - –û—Ç–ø—Ä–∞–≤–∫–∞: "‚úÖ –ó–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω\n–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é..."
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `tech_msg_id` –≤ –∫—ç—à –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
   - **–£–¥–∞–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞**, –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ç–æ

5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –∏–∑ Kafka:**
   - Topic: `responses`
   - –î–≤–∞ —Ç–∏–ø–∞ –æ—Ç–≤–µ—Ç–æ–≤:
     - `action='chat'` ‚Üí —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç ‚Üí —É–¥–∞–ª–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞
     - `action='image_type'` ‚Üí —Ç–µ–º–∞ –¥–ª—è —Ñ–æ—Ç–æ ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ ‚Üí —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Å—Ç–∞—ë—Ç—Å—è

6. **–û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞:**
   - –¢–µ–∫—Å—Ç: MarkdownV2 —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ä–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ —á–∞—Å—Ç–∏ –µ—Å–ª–∏ > 4000 —Å–∏–º–≤–æ–ª–æ–≤
   - –§–æ—Ç–æ: –≤—ã–±–æ—Ä –ø–æ —Ç–µ–º–µ –∏ –∞–ª–≥–æ—Ä–∏—Ç–º—É —Ä–æ—Ç–∞—Ü–∏–∏

### –¢–∏–ø—ã –∑–∞–ø—Ä–æ—Å–æ–≤

| –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –¢—Ä–µ–±—É–µ—Ç RAG | Kafka Action |
|-----|----------|-------------|--------------|
| `user` | –û–±—ã—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | ‚úÖ | `chat` |
| `push_weekly_forecast` | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—É—à: –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –Ω–µ–¥–µ–ª—é (–ü–Ω 10:00) | ‚úÖ | `prediction` |
| `push_situational` | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—É—à: —Å–∏—Ç—É–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (–°—Ä 13:00, –í—Å 9:00) | ‚úÖ | `chat` |
| `push_premium_limit` | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—É—à: –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –ø–ª–∞—Ç–Ω–æ–º –ª–∏–º–∏—Ç–µ (–ü—Ç 13:00) | ‚ùå | - |

### –ö–æ–º–∞–Ω–¥—ã

#### `/start`
- –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫: –∑–∞–ø—Ä–æ—Å –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è
- –í–æ–∑–≤—Ä–∞—â–∞—é—â–∏–π—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ

#### `/reset_birth_data`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è (24 —á–∞—Å–∞)
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –≤–≤–æ–¥ "–ü–û–î–¢–í–ï–†–î–ò–¢–¨"
- –°–±—Ä–æ—Å –¥–∞—Ç—ã –∏ —Ñ–ª–∞–≥–∞ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã

#### `/help`
- –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥

#### `/my_info`
- –î–∞—Ç–∞ –∏ –º–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è
- –°—Ç–∞—Ç—É—Å –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î)
- –°—Ç–∞—Ç—É—Å —Ç–∞—Ä–∏—Ñ–∞ (–ø–ª–∞—Ç–Ω—ã–π/–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π)
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### Kafka —Å–æ–æ–±—â–µ–Ω–∏—è

**–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ (topic: `requests`):**
```json
{
  "request_text": "—Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞",
  "natal_chart": { /* JSON –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã */ }
}
```
Headers: `request_id`, `bot_id`, `chat_id`, `action`

**–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ (topic: `responses`):**
```json
{
  "request_id": "uuid",
  "bot_id": "astro1",
  "chat_id": 123456789,
  "response_text": "–æ—Ç–≤–µ—Ç –æ—Ç RAG –∏–ª–∏ —Ç–µ–º–∞ –¥–ª—è —Ñ–æ—Ç–æ"
}
```
Headers: `action` (`chat` –∏–ª–∏ `image_type`)

### –°—Ç–∞—Ç—É—Å—ã –∑–∞–ø—Ä–æ—Å–æ–≤

- `sent_to_rag` (1) - –∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Kafka
- `completed` (2) - –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- `error` (3) - –æ—à–∏–±–∫–∞ –Ω–∞ –∫–∞–∫–æ–º-—Ç–æ —ç—Ç–∞–ø–µ

### –≠—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ (RequestStage)

**–§–∞–∑–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ (PhaseSend):**
- `create_request` - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –≤ –ë–î
- `load_natal_chart` - –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã
- `kafka_send` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Kafka

**–§–∞–∑–∞ –ø—Ä–∏—ë–º–∞ (PhaseReceive):**
- `get_request` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ –ë–î
- `save_response` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –≤ –ë–î
- `send_telegram` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
- `get_image_usage` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–æ–∫
- `get_images` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –ø–æ —Ç–µ–º–µ
- `select_image` - –≤—ã–±–æ—Ä –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–æ –∞–ª–≥–æ—Ä–∏—Ç–º—É
- `send_photo` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ –≤ Telegram

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

**–û—Ç–ø—Ä–∞–≤–∫–∞:**
- –¢–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (`RequestTypeUser`)
- –°–æ–æ–±—â–µ–Ω–∏–µ: "‚úÖ –ó–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω\n–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é..."
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `tech_msg_id` –≤ –∫—ç—à —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ `request_id`

**–£–¥–∞–ª–µ–Ω–∏–µ:**
- –¢–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (`action='chat'`)
- –ù–µ —É–¥–∞–ª—è–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ç–æ (`action='image_type'`)
- –ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ `TryDeleteTechMsg`

### Rerank-natal

**–¢—Ä–∏–≥–≥–µ—Ä:** –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã –ø—Ä–∏ –Ω–∞—á–∞–ª—å–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Kafka:**
- Topic: `requests`
- Headers:
  - `action=rerank_natal` (—Ö–∞—Ä–¥–∫–æ–¥)
  - `bot_id` - ID –±–æ—Ç–∞
  - `chat_id` - ID —á–∞—Ç–∞
- Value: `{"request_text": "", "natal_chart": <natal_report>}`

**–£—Å–ª–æ–≤–∏–µ:** –§–ª–∞–≥ `rerank=true` –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ `fetchAndSaveNatalChart` –ø—Ä–∏ –Ω–∞—á–∞–ª—å–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–≤–≤–æ–¥ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è), –≤–æ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö `rerank=false`.
